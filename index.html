<!DOCTYPE html>
<html>
<head>
	<title>My Canvas Game</title>
	<style type="text/css">
	   * { margin: 0px; padding: 0px; }
	   /*canvas { margin: 8% auto; display: block;}*/
	</style>
</head>
<body>
	<canvas id="swingbot"></canvas>

	<script type="text/javascript">
		
		var canvas = document.getElementById('swingbot'),
			bot = {},
			bullet = {},
			context = canvas.getContext('2d'),
			bars = [],
			barCount = 3,
			barWidth = 100,
			barHeight = 15,
			firedPointX = 0,
			firedPointY = 0,
			barHitPointX = 0,
			barHitPointY = 0,
			barHit = false,
			bulletFired = false,
			bulletSpeed = 15;

		canvas.width = 400;
		canvas.height = 500;

		context = canvas.getContext('2d');

		bot.width = 10;
		bot.height = 10;
		bot.posX = canvas.width / 2;
		bot.posY = canvas.height - bot.height - 10;

		bullet.posX = 0;
		bullet.posY = 0;
		bullet.height = 4;
		bullet.width = 4;

		var relAngleX, relAngleY, relFiredPointX, relFiredPointY;

		// Generate the bars positions
		for (var i = 0; i < barCount; i++) {
			bars.push({
				posX: Math.random() * ( canvas.width / 2 ),
				posY: ( canvas.height / barCount ) * i     // So to make the bars span the whole height
			});
		};

		canvas.onclick = function ( ev ) {

			// Reset the bar hit or it will start throwing the rope
			// ..instead of the bullet
			barHit = false;

			firedPointX = ev.clientX;
			firedPointY = ev.clientY;

			relFiredPointX = firedPointX - bot.posX;
			relFiredPointY = firedPointY - bot.posY;

			relAngleX = relAngleY = Math.atan2(relFiredPointY, relFiredPointX) * 57.32;

			bulletFired = true;
		}

		window.setInterval(function () {
			// Clear 
			context.clearRect(0, 0, canvas.width, canvas.height);

			// Create the player
			context.fillRect(bot.posX, bot.posY, bot.width, bot.height);

			// Draw the bars
			for (var i = 0; i < barCount; i++) {
				context.fillRect(bars[i].posX, bars[i].posY, barWidth, barHeight);
			};

			// If the bullet gets fired
			if ( bulletFired ) {
				
				// If it is the first frame after bullet got fired
				if ( !bullet.posX && !bullet.posY ) {
					bullet.posX = bot.posX;
					bullet.posY = bot.posY;
				};

				// Increment the bullet position so that it may move to the position
				// ..towards which it is fired
				bullet.posX += Math.cos(relAngleX * 0.017) * bulletSpeed;
				bullet.posY -= Math.sin(relAngleY * -0.017) * bulletSpeed;

				// If the bullet tries to go outside the canvas in sideways
				if ( ( bullet.posX > canvas.width ) || ( bullet.posX < 0 ) ) {
					// To divert the bullet in the reverse direction
					relAngleX = relAngleX - relAngleY;
				};

				// To check if the bullet has hit any of the bars
				for (var i = 0; i < barCount; i++) {

					// If the bullet's current position overlaps with 
					// any of the bars
					if ((
						bullet.posX >= bars[i].posX &&
						bullet.posX <= ( bars[i].posX + barWidth )
					) && (
						bullet.posY >= bars[i].posY &&
						bullet.posY <= ( bars[i].posY + barHeight ) 
					)) {
						// ^Added 5 to the height of bar to avoid the glitch
						// where the rope wasn't able to hook itself
						// in the middle of the bar
						// @todo Implement the proper solution, adding the number
						//       causes it to even hook the into the air on some points on bar
						
						// No bullet fired, it was a bar hit
						bulletFired = false;
						barHit = true;
							
						// Change the fired point, as this is the point where the rope will be thrown
						firedPointX = bullet.posX;
						firedPointY = bullet.posY;

						// Reset the bullet position
						bullet.posX = bullet.posY = 0;

						return;
					};
				};

				// Show the bullet
				context.fillRect(bullet.posX, bullet.posY, bullet.width, bullet.height);

				// If the bullet goes out of the top of canvas
				if ( bullet.posY < 0 ) {
					// Reset that bullet
					bullet.posX = bullet.posY = 0;
					bulletFired = false
				};
			};

			// If the bar was hit and the bot is not above the fired point
			if ( barHit && bot.posY > ( firedPointY + 20 ) ) {
				context.beginPath();
				context.moveTo( bot.posX, bot.posY );
				context.lineTo(firedPointX, firedPointY);
				context.stroke();
			};

		}, 10);

	</script>
</body>
</html>